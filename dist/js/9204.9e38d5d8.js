"use strict";(self.webpackChunkecshopx_admin=self.webpackChunkecshopx_admin||[]).push([[9204],{9204:function(t,e,a){a.r(e),a.d(e,{default:function(){return c}});a(44114),a(18111),a(20116),a(7588);var i=a(18306),n=a(98818),r=a(2038),s=a(77825),o={mixins:[s.Ay,s.v8],provide(){return{refresh:this.fetchList}},data(){const t={date_status:"2",card_type:void 0,status:void 0,store_self:void 0},e=[{text:$t("ex2h93","折扣券","lang"),value:"discount"},{text:$t("gn10q3","满减券","lang"),value:"cash"}];return this.VERSION_STANDARD()&&e.push({text:$t("ce4vb3","兑换券","lang"),value:"new_gift"}),{initialParams:t,params:{...t},loading:!1,loadingbtn:!1,sendoutVisible:!1,currSendout:1,checkedType:{},typeId:-1,sedoutList:[{name:$t("vknegp5","下载二维码","lang"),id:3}],typeFilters:e,tabList:[{name:$t("ebukb3","已生效","lang"),activeName:"2"},{name:$t("ek5e63","待生效","lang"),activeName:"1"},{name:$t("ege5m3","已过期","lang"),activeName:"3"}],isShopadmin:/\/shopadmin/.test(document.location.pathname),appID:"",appCodeUrl:"",curPageUrl:"",editDialog:!1,editForm:{card_id:"",type:"increase",quantity:1},editFormList:[{label:"",key:"type",type:"radio",options:[{label:"increase",name:$t("fiyq2","增加","lang")},{label:"reduce",name:$t("ef4y2","减少","lang")}]},{label:$t("i1y72","数量","lang"),key:"quantity",type:"input",placeholder:$t("2j83945","请输入数量","lang"),validator:(t,e,a)=>{const i=this.tableList.find(t=>t.card_id==this.editForm.card_id);"reduce"==this.editForm.type&&this.editForm.quantity>i.quantity-i.get_num?a(new Error($t("befdtgd","减少数量不能大于可领取库存","lang"))):a()}}],dmcrmSetting:{}}},mounted(){this.params.store_self=!1,this.VERSION_PLATFORM()&&"distributor"!==i.A.getters.login_type&&(this.params.store_self=!0),this.fetchList(),this.fetchWechatList(),this.getDmcrmSetting()},methods:{async getDmcrmSetting(){const t=await this.$api.third.getDmcrmSetting();this.dmcrmSetting=t},async fetchWechatList(){const{list:t}=await this.$api.minimanage.gettemplateweapplist();t.forEach((t,e)=>{"yykweishop"==t.key_name&&(this.appID=t.authorizer.authorizer_appid)})},handleShow(t){const e="subpages/marketing/coupon-center";this.curPageUrl=`${e}?card_id=${t}`;let a={wxaAppId:this.appID,page:e,card_id:t};(0,r.getPageCode)(a).then(t=>{this.appCodeUrl=t.data.data.base64Image})},handleDownload(t){var e=document.createElement("a"),a=t;this.appCodeUrl&&(e.href=this.appCodeUrl,e.download=a+".png",e.click())},editCouponStore(t){this.editForm.card_id=t,this.editDialog=!0},async onEditSubmit(){await this.$api.cardticket.updateStore(this.editForm),this.editDialog=!1,this.fetchList()},getParams(){return{...this.params}},onSearch(){this.page.pageIndex=1,this.$nextTick(()=>{this.fetchList()})},onReset(){this.params={...this.initialParams},this.onSearch()},async fetchList(){this.loading=!0;const{pageIndex:t,pageSize:e}=this.page;let a={page_no:t,page_size:e,...this.getParams()};const{list:i,total_count:n}=await this.$api.cardticket.getCardList(a);this.tableList=i,this.page.total=n,this.loading=!1},handleClick(t,e){this.onSearch()},addCoupon(){this.$router.push({path:this.matchRoutePath("editor")})},sendoutShowAction(t){this.sendoutVisible=!0,this.typeId=t,this.currSendout=0},sendoutAction(){0==this.currSendout&&this.typeId&&(0,n.getQRcode)(this.typeId).then(t=>{var e=document.createElement("a");e.href=t.data.data.show_qrcode_url,e.download=!0,e.click()}),this.sendoutVisible=!1},deleteCard(t,e){this.$confirm($t("a2ma1w9","确定要删除该卡券？","lang"),$t("hn562","提示","lang"),{cancelButtonText:$t("ev022","取消","lang"),confirmButtonText:$t("kzjg2","确定","lang"),type:"warning",beforeClose:(a,i,r)=>{"confirm"===a&&(0,n.removeCard)({card_id:t}).then(t=>{this.tableList.splice(e,1)}),r()}})},chooseSendout(t){this.currSendout=t},pullWechatCard(){this.$confirm($t("7b6dwgf","确定同步微信优惠券到本系统吗？","lang"),$t("hn562","提示","lang"),{confirmButtonText:$t("kzjg2","确定","lang"),cancelButtonText:$t("ev022","取消","lang"),type:"warning"}).then(()=>{pullWechatCard().then(t=>{this.$message({message:$t("b1twyw4","同步成功","lang"),type:"success",duration:5e3})})}).catch(()=>{this.$message({type:"info",message:$t("e68dg3","已取消","lang")})})},filterTag(t){t.type&&(this.params.card_type=t.type[0],this.fetchList()),t.status&&(this.params.status=t.status,this.fetchList())},saveStore(t,e){this.loadingbtn=!0;if(/^[1-9]\d*$/.test(this.tableList[t].storeValue)){if("reduce"==e){var a=Number(this.tableList[t].quantity)>this.tableList[t].get_num?Number(this.tableList[t].quantity)-this.tableList[t].get_num:0;if(this.tableList[t].storeValue>a)return void this.$message({message:$t("befdtgd","减少数量不能大于可领取库存","lang"),type:"error"})}var i={card_id:this.tableList[t].card_id,type:this.tableList[t].operationType,quantity:this.tableList[t].storeValue};(0,n.updateStore)(i).then(t=>{setTimeout(()=>{this.loadingbtn=!1},1e3),this.fetchList()})}else this.$message({message:$t("w974mda","请输入大于0的正整数","lang"),type:"error"})}}},l=(0,a(81656).A)(o,function(){var t=this,e=t._self._c;return e("SpPage",[e("SpRouterView",[e("SpPlatformTip",{attrs:{h5:"",app:"",pc:"",alipay:""}}),t.dmcrmSetting.is_open?e("SpPlatformTip",{staticClass:"damo-crm-tip",attrs:{"text-val":$t("fjqnq210","优惠券已被达摩CRM接管，维护请前往达摩CRM后台进行维护，此处仅作展示","lang")}}):t._e(),t.dmcrmSetting.is_open?t._e():e("div",{staticClass:"action-container"},[e("el-button",{attrs:{type:"primary",icon:"iconfont icon-xinzengcaozuo-01"},on:{click:t.addCoupon}},[t._v($t("6o66xb7"," 创建优惠券 ","lang"))])],1),e("el-tabs",{attrs:{type:"card"},on:{"tab-click":t.handleClick},model:{value:t.params.date_status,callback:function(e){t.$set(t.params,"date_status",e)},expression:"params.date_status"}},t._l(t.tabList,function(a,i){return e("el-tab-pane",{key:i,attrs:{label:a.name,name:a.activeName}},[e("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],attrs:{data:t.tableList,border:""},on:{"filter-change":t.filterTag}},[e("el-table-column",{attrs:{width:"200",label:$t("hkxb2","操作","lang")},scopedSlots:t._u([{key:"default",fn:function(a){return[e("div",{staticClass:"operating-icons"},[e("el-button",{attrs:{type:"text"}},[e("router-link",{attrs:{to:{path:t.matchRoutePath("detail"),query:{chooseCardtype:a.row.card_type,cardId:a.row.card_id,title:a.row.title}}}},[t._v($t("gcika4"," 查看 ","lang"))])],1),"Y"==a.row.edit_btn&&(t.isShopadmin?parseInt(a.row.source_id)>0:parseInt(a.row.source_id)<=0)?e("el-button",{attrs:{type:"text"}},[e("router-link",{attrs:{to:{path:t.matchRoutePath("editor"),query:{chooseCardtype:a.row.card_type,cardId:a.row.card_id}}}},[t._v($t("juz394"," 编辑 ","lang"))])],1):t._e(),e("el-popover",{attrs:{placement:"top",width:"200",trigger:"click"}},[e("div",[e("img",{staticClass:"page-code",attrs:{src:t.appCodeUrl}}),e("div",{staticClass:"page-btns"},[e("el-button",{attrs:{type:"primary",plain:"",size:"mini"},on:{click:function(e){return t.handleDownload(a.row.title)}}},[t._v($t("axjir55"," 下载码 ","lang"))]),e("el-button",{directives:[{name:"clipboard",rawName:"v-clipboard:copy",value:t.curPageUrl,expression:"curPageUrl",arg:"copy"}],attrs:{type:"primary",plain:"",size:"mini"}},[t._v($t("j66ck06"," 复制链接 ","lang"))])],1)]),e("el-button",{staticStyle:{width:"45px"},attrs:{slot:"reference",type:"text"},on:{click:function(e){return t.handleShow(a.row.card_id)}},slot:"reference"},[t._v($t("fhh3r4"," 投放 ","lang"))])],1),"CARD_STATUS_DISPATCH"!=a.row.status?e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.deleteCard(a.row.card_id,a.$index)}}},[t._v($t("db22k4"," 删除 ","lang"))]):t._e()],1)]}}],null,!0)}),e("el-table-column",{attrs:{prop:"card_type","column-key":"type",label:$t("av8hwn4","卡券类型","lang"),width:"120","filter-multiple":!1,filters:t.typeFilters,"filter-placement":"bottom-end"},scopedSlots:t._u([{key:"default",fn:function(a){return[e("el-tag",{attrs:{type:"discount"===a.row.card_type?"primary":"cash"===a.row.card_type?"danger":"warning",size:"mini"}},[t._v(" "+t._s(t._f("formatCardStr")(a.row.card_type))+" ")])]}}],null,!0)}),e("el-table-column",{attrs:{prop:"title",label:$t("av5dig4","卡券标题","lang")}}),e("el-table-column",{attrs:{width:"350",label:$t("icb16f5","卡券有效期","lang")},scopedSlots:t._u([{key:"default",fn:function(a){return[e("i",{staticClass:"el-icon-time"}),a.row.takeEffect?[t._v(" "+t._s(a.row.takeEffect)+" ")]:[t._v(" "+t._s(t._f("datetime")(a.row.begin_time,"YYYY-MM-DD HH:mm:ss"))+" "),a.row.end_time?[t._v(" ~ ")]:t._e(),t._v(" "+t._s(t._f("datetime")(a.row.end_time,"YYYY-MM-DD HH:mm:ss"))+" ")]]}}],null,!0)}),e("el-table-column",{attrs:{width:"120",label:$t("7duixo5","可领取库存","lang")},scopedSlots:t._u([{key:"default",fn:function(a){return[a.row.quantity>a.row.get_num?e("span",[t._v(t._s(a.row.quantity-a.row.get_num))]):e("span",[t._v("0")]),"Y"===a.row.edit_btn?e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.editCouponStore(a.row.card_id)}}},[e("i",{staticClass:"el-icon-edit"})]):t._e()]}}],null,!0)}),e("el-table-column",{attrs:{width:"200",prop:"source_name",label:$t("gwn72","店铺","lang")}}),e("el-table-column",{attrs:{width:"240",label:$t("hkxb2","操作","lang")},scopedSlots:t._u([{key:"default",fn:function(a){return[e("div",{staticClass:"operating-icons"},[e("el-button",{attrs:{type:"text"}},[e("router-link",{attrs:{to:{path:t.matchRoutePath("detail"),query:{chooseCardtype:a.row.card_type,cardId:a.row.card_id,title:a.row.title}}}},[t._v($t("gcika4"," 查看 ","lang"))])],1),e("el-button",{attrs:{type:"text"}},[e("router-link",{attrs:{to:{path:t.matchRoutePath("info"),query:{cardId:a.row.card_id,onlyShow:!0}}}},[t._v($t("likox4"," 详情 ","lang"))])],1),"Y"==a.row.edit_btn&&(t.isShopadmin?parseInt(a.row.source_id)>0:parseInt(a.row.source_id)<=0)&&!t.dmcrmSetting.is_open?e("el-button",{attrs:{type:"text"}},[e("router-link",{attrs:{to:{path:t.matchRoutePath("editor"),query:{chooseCardtype:a.row.card_type,cardId:a.row.card_id}}}},[t._v($t("juz394"," 编辑 ","lang"))])],1):t._e(),t.appID?e("el-popover",{attrs:{placement:"top",width:"200",trigger:"click"}},[e("div",[e("img",{staticClass:"page-code",attrs:{src:t.appCodeUrl}}),e("div",{staticClass:"page-btns"},[e("el-button",{attrs:{type:"primary",plain:"",size:"mini"},on:{click:function(e){return t.handleDownload(a.row.title)}}},[t._v($t("axjir55"," 下载码 ","lang"))]),e("el-button",{directives:[{name:"clipboard",rawName:"v-clipboard:copy",value:t.curPageUrl,expression:"curPageUrl",arg:"copy"}],attrs:{type:"primary",plain:"",size:"mini"}},[t._v($t("j66ck06"," 复制链接 ","lang"))])],1)]),e("el-button",{staticStyle:{width:"45px"},attrs:{slot:"reference",type:"text"},on:{click:function(e){return t.handleShow(a.row.card_id)}},slot:"reference"},[t._v($t("fhh3r4"," 投放 ","lang"))])],1):t._e(),"CARD_STATUS_DISPATCH"==a.row.status||t.dmcrmSetting.is_open?t._e():e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.deleteCard(a.row.card_id,a.$index)}}},[t._v($t("db22k4"," 删除 ","lang"))])],1)]}}],null,!0)}),e("el-table-column",{attrs:{width:"200",prop:"source_name",label:$t("gwn72","店铺","lang")}})],1),e("div",{staticClass:"mt-4 text-right"},[e("el-pagination",{attrs:{layout:"total, sizes, prev, pager, next, jumper",total:t.page.total,"page-size":t.page.pageSize},on:{"current-change":t.onCurrentChange,"size-change":t.onSizeChange}})],1)],1)}),1),e("el-dialog",{attrs:{title:$t("8np100b","您可以通过以下方式投放","lang"),visible:t.sendoutVisible},on:{"update:visible":function(e){t.sendoutVisible=e}}},[t._l(t.sedoutList,function(a,i){return e("div",{key:i,staticClass:"sendout-item",class:{checked:t.currSendout===i},on:{click:function(e){return t.chooseSendout(i)}}},[e("div",[t._v(t._s(a.name))]),e("div",{staticClass:"icon-checked"},[e("i",{staticClass:"el-icon-circle-check"})])])}),e("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e("el-button",{nativeOn:{click:function(e){t.sendoutVisible=!1}}},[t._v($t("dd4ni4"," 取消 ","lang"))]),e("el-button",{attrs:{type:"primary"},nativeOn:{click:function(e){return t.sendoutAction.apply(null,arguments)}}},[t._v($t("in1ck4"," 确定 ","lang"))])],1)],2)],1),e("SpDialog",{ref:"editDialogRef",attrs:{width:"500px",title:$t("tgt98g5","修改库存数","lang"),form:t.editForm,"form-list":t.editFormList},on:{onSubmit:t.onEditSubmit},model:{value:t.editDialog,callback:function(e){t.editDialog=e},expression:"editDialog"}})],1)},[],!1,null,"c8789130",null),c=l.exports}}]);