"use strict";(self.webpackChunkecshopx_admin=self.webpackChunkecshopx_admin||[]).push([[2844],{92844:function(e,t,i){i.r(t),i.d(t,{default:function(){return u}});i(44114),i(18111),i(7588),i(61701);var a=i(54573),s=(i(20116),i(5748)),l={components:{GoodsSelector:a.default},props:{data:{type:Array,default:[]},hiddenData:{type:Array,default:[]},limit:{type:Number,default:0},relStore:{type:Object,default:()=>({})},lockStore:{type:Boolean,default:!1},needStore:{type:Boolean,default:!1},isInputShow:{type:Boolean,default:!0}},data(){return{loading:!1,goods:[],current:"",currentPage:1,skuParams:{page:1,pageSize:-1,item_type:"normal",approve_status:"onsale",is_sku:!0,item_id:""},skuTotal:0,skus:[],checkedSkus:[],dialogVisible:!1,itemVisible:!1,setItemStatus:!1,relItems:[],item_type:"normal",itemNewPrice:[],hiddenItem:[]}},watch:{data(e){this.goods=e,this.relItems=JSON.parse(JSON.stringify(e)),this.generateSku()},hiddenData(e){for(var t in this.hiddenItem=[],e)this.hiddenItem.push(e[t].itemId)}},methods:{handleSkuDialogShow(e){const t=this;this.loading=!0,this.current=e,this.skuParams.item_id=this.goods[e].default_item_id,this.dialogVisible=!0;let i=this.goods[e].spec_items;(0,s.getItemsList)(this.skuParams).then(e=>{this.skus=e.data.data.list,this.$nextTick(()=>{t.skus.forEach(e=>{-1!==i.findIndex(t=>e.itemId===t.itemId)&&t.$refs.skuTable.toggleRowSelection(e)})}),this.loading=!1})},handleGoodsDialogShow(){this.itemVisible=!0,this.setItemStatus=!0},handleSkuChange(e){this.checkedSkus=e},handleSkuSubmit(){this.dialogVisible=!1,this.goods[this.current].spec_items=this.checkedSkus,this.generateSku()},handleGoodsSubmit(e){if(e.length>10)return void this.$message({message:$t("dqlr4x9","最大选择10个商品","lang"),type:"error"});if(this.itemVisible=!1,null===e||e.length<=0)return;this.relItems=e;let t=[];e.forEach(e=>{Object.assign(e,{new_price:void 0===this.itemNewPrice[e.item_id]?"":this.itemNewPrice[e.item_id]}),e.nospec?t.push(e):t.push(Object.assign(e,{spec_items:[]}))}),this.goods.length>0&&t.forEach(e=>{let t=this.goods.find(t=>e.itemId===t.item_id);t&&t.spec_items&&t.spec_items.length>0&&(e.spec_items=t.spec_items)}),this.goods=JSON.parse(JSON.stringify(t)),this.generateSku()},generateSku(){let e=[],t=[],i=0,a=JSON.parse(JSON.stringify(this.goods));if(this.itemNewPrice=[],a.forEach(t=>{t.nospec||0!==t.spec_items.length||e.push(t.default_item_id)}),e.length>0){this.skuParams.item_id=e,(0,s.getItemsList)(this.skuParams).then(e=>{a.forEach(t=>{t.nospec||e.data.data.list.forEach(e=>{t.item_id===e.default_item_id&&t.spec_items.push(e)})}),a.forEach(e=>{i+=e.new_price?parseFloat(e.new_price):0,this.itemNewPrice[e.item_id]=e.new_price?parseFloat(e.new_price):0,e.nospec?t=[...t,e]:(e.spec_items=e.spec_items.map(t=>({...Object.assign({},t,{new_price:e.new_price})})),t=[...t,...e.spec_items])}),this.$emit("change",t),this.$emit("newPrice",i)})}else a.forEach(e=>{if(i+=e.new_price?parseFloat(e.new_price):0,this.itemNewPrice[e.item_id]=e.new_price?parseFloat(e.new_price):0,e.nospec)t=[...t,e];else{const i=e.spec_items.map(e=>({...Object.assign({},e,{new_price:e.new_price})}));t=[...t,...i]}}),this.$emit("change",t),this.$emit("newPrice",i)},handleGoodsDialogHide(){this.itemVisible=!1},handleSkuRemove(e){this.goods.splice(e,1),this.relItems.splice(e,1),this.generateSku()}}},r=i(81656),n=(0,r.A)(l,function(){var e=this,t=e._self._c;return t("div",[e.goods.length>0?t("el-row",{attrs:{gutter:20}},e._l(e.goods,function(i,a){return t("el-col",{key:a,attrs:{xs:24,sm:12,md:8,lg:6}},[t("div",{staticClass:"goods"},[t("div",{staticClass:"goods-thumbnail"},[t("img",{attrs:{src:i.pics[0],alt:""}})]),t("div",{staticClass:"goods-caption"},[t("div",{staticClass:"goods-title"},[e._v(" "+e._s(i.itemName)+" ")]),t("div",{staticClass:"goods-sku"},[i.nospec?e._e():[e._v(" "+e._s(i.spec_items.length>0?$t("grpz2","已选","lang")+i.spec_items.length:$t("cl9b43","全规格","lang"))+" "),t("div",{staticClass:"goods-sku-check",on:{click:function(t){return e.handleSkuDialogShow(a)}}},[e._v($t("il5vco4","选择规格","lang"))])]],2)]),t("div",{staticClass:"goods-remove iconfont icon-trash-alt",on:{click:function(t){return e.handleSkuRemove(a)}}})]),e.isInputShow?t("div",{staticClass:"grid-content bg-purple"},[t("el-input",{attrs:{type:"input",placeholder:$t("70h3s46","组合商品价格","lang")},on:{change:function(t){return e.generateSku()}},model:{value:i.new_price,callback:function(t){e.$set(i,"new_price",t)},expression:"item.new_price"}},[e._v($t("aveuqz5"," 价格: ","lang"))])],1):e._e()])}),1):e._e(),t("div",[t("el-button",{attrs:{disabled:e.needStore&&!e.relStore.id,type:"primary"},on:{click:e.handleGoodsDialogShow}},[e._v($t("mwtd0l6"," 选择商品 ","lang"))])],1),t("el-dialog",{attrs:{title:$t("7eju3h5","选择sku","lang"),visible:e.dialogVisible,width:"50%"},on:{"update:visible":function(t){e.dialogVisible=t}}},[t("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],ref:"skuTable",attrs:{data:e.skus},on:{"selection-change":e.handleSkuChange}},[t("el-table-column",{attrs:{type:"selection",width:"55"}}),t("el-table-column",{attrs:{label:$t("ht82nv4","规格名称","lang")},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(t.row.item_spec_desc)+" ")]}}])}),t("el-table-column",{attrs:{label:$t("e04l2","价格","lang")},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" ¥"+e._s(t.row.price/100)+" ")]}}])})],1),t("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.dialogVisible=!1}}},[e._v($t("caoqm3","取 消","lang"))]),t("el-button",{attrs:{type:"primary"},on:{click:e.handleSkuSubmit}},[e._v($t("hnjoo3","确 定","lang"))])],1)],1),t("GoodsSelector",{attrs:{"items-visible":e.itemVisible,"get-status":e.setItemStatus,"rel-store":e.relStore,"lock-store":e.lockStore,"rel-items-ids":e.relItems,"hidden-data":e.hiddenItem,"item-type":e.item_type},on:{chooseStore:e.handleGoodsSubmit,closeStoreDialog:e.handleGoodsDialogHide}})],1)},[],!1,null,"36400a22",null).exports,o=i(65124),c=i(98818),m=i(5134),d={inject:["refresh"],components:{SkuSelector:n,GoodsSelect:a.default},data(){return{cursymbol:"￥",relItems:[],relItemsTemp:[],validGrade:[],vipGrade:[],memberGrade:[],activity_date:"",form:{package_name:"",used_platform:0,free_postage:1,items:[],main_item:{},main_items:[],valid_grade:[],source_id:"0"},relMain:[],setMainStatus:!1,mainVisible:!1,curStore:{},singleData:!0,hasSaveButton:!0,skuParams:{page:1,pageSize:-1,item_type:"normal",approve_status:"onsale",is_sku:!0,item_id:""},dialogVisible:!1,skus:[],checkedSkus:[]}},computed:{usePlatformVisiable(){return(!this.IS_ADMIN()||"0"==this.form.source_id)&&!this.IS_DISTRIBUTOR()}},mounted(){this.$route.query.isshow&&(this.hasSaveButton=!1),this.getListVipGrade(),this.getGradeList(),this.$route.params.package_id&&this.getPackagePromotionsInfo(this.$route.params.package_id)},methods:{submitActivityAction(){const e=this;this.activity_date.length>0&&(this.form.start_time=this.activity_date[0]/1e3,this.form.end_time=this.activity_date[1]/1e3),this.validGrade.length>0&&(this.form.valid_grade=this.validGrade),this.relMain.length>0&&(this.form.main_item={item_id:this.relMain[0].item_id,item_price:this.relMain[0].price}),this.$route.params.package_id?(0,m.updatePackagePromotions)(this.$route.params.package_id,this.form).then(t=>{this.loading=!1,this.$message({message:$t("ai8d7e4","修改成功","lang"),type:"success",duration:2e3,onClose(){e.refresh(),e.$router.go(-1)}})}).catch():(0,m.createPackagePromotions)(this.form).then(t=>{this.loading=!1,this.$message({message:$t("e7ygyc4","添加成功","lang"),type:"success",duration:2e3,onClose(){e.refresh(),e.$router.go(-1)}})}).catch()},getItems(e){let t=[];this.relItemsTemp=JSON.parse(JSON.stringify(e)),e.forEach(e=>{t.push({item_id:e.itemId,item_title:e.itemName,activity_store:e.store,new_price:e.new_price/100,item_spec_desc:e.item_spec_desc,sort:e.sort,limit_num:0,item_type:e.item_type})}),this.form.items=t},getListVipGrade(){(0,c.listVipGrade)().then(e=>{null!=e&&e.data.data&&e.data.data.length>0&&(this.vipGrade=e.data.data)})},getGradeList(){(0,o.getGradeList)().then(e=>{if(null!=e&&e.data.data&&e.data.data.length>0){var t=e.data.data;t&&(this.memberGrade=t)}})},getPackagePromotionsInfo(e){(0,m.getPackagePromotionsInfo)(e).then(e=>{this.form.used_platform=e.data.data.used_platform,this.form.free_postage=e.data.data.free_postage,this.form.package_name=e.data.data.package_name,this.form.source_id=e.data.data.source_id,this.validGrade=e.data.data.valid_grade,e.data.data.itemTreeLists.forEach(t=>{t.spec_items&&t.spec_items.length>0?t.spec_items.map(t=>{for(let i in e.data.data.new_price)i===t.item_id&&(t.price=e.data.data.new_price[i])}):t.price=t.new_price}),e.data.data.main_items.forEach(e=>{e.item_price=Number(e.item_price)/100}),this.form.main_items=e.data.data.main_items,this.relMain=JSON.parse(JSON.stringify(e.data.data.mainItem)),this.relMain[0].price=e.data.data.mainItem[0].price/100,this.relItems=e.data.data.itemTreeLists,this.activity_date=[1e3*e.data.data.start_time,1e3*e.data.data.end_time]})},closeMainDialogAction(){this.mainVisible=!1},deleteMainItemRow(e,t){t.splice(e,1),this.form.main_items=t},deleteItemRow(e,t){t.splice(e,1),this.form.items=t},chooseMainAction(e,t){this.mainVisible=!1,this.relMain=JSON.parse(JSON.stringify(e)),this.relMain[0].nospec?this.relMain[0].spec_items=this.relMain[0].spec_items:this.relMain[0].spec_items=[],this.relMain[0].price=this.relMain[0].price/100;let i=this.relItemsTemp.findIndex(e=>e.itemId===this.relMain[0].itemId);this.relItemsTemp.splice(i,1),this.relItems=JSON.parse(JSON.stringify(this.relItemsTemp)),t.id?this.curStore=t:this.curStore={id:"0",name:$t("h5vx2","总部","lang")},this.getMainItemList(this.relMain[0].item_id)},getMainItemList(e){this.skuParams.item_id=e;let t=[];(0,s.getItemsList)(this.skuParams).then(e=>{e.data.data.list.forEach(e=>{t.push({item_id:e.itemId,item_title:e.itemName,activity_store:e.store,item_price:e.price/100,item_spec_desc:e.item_spec_desc,sort:e.sort,limit_num:0,item_type:e.item_type})}),this.form.main_items=t})},handleSkuChange(e){this.checkedSkus=e},handleSkuDialogShow(){const e=this;this.skuParams.item_id=this.relMain[0].item_id,this.dialogVisible=!0;let t=this.relMain[0].spec_items;(0,s.getItemsList)(this.skuParams).then(i=>{this.skus=i.data.data.list,this.$nextTick(()=>{e.skus.forEach(i=>{-1!==t.findIndex(e=>i.item_id===e.item_id)&&e.$refs.skuTable.toggleRowSelection(i)})})})},handleSkuSubmit(){this.dialogVisible=!1,this.relMain[0].spec_items=this.checkedSkus;let e=[];this.checkedSkus.length>0?(this.checkedSkus.forEach(t=>{e.push({item_id:t.itemId,item_title:t.itemName,activity_store:t.store,item_price:t.price/100,item_spec_desc:t.item_spec_desc,sort:t.sort,limit_num:0,item_type:t.item_type})}),this.relMain[0].spec_items=e,this.form.main_items=e):(this.skus.forEach(t=>{e.push({item_id:t.itemId,item_title:t.itemName,activity_store:t.store,item_price:t.price/100,item_spec_desc:t.item_spec_desc,sort:t.sort,limit_num:0,item_type:t.item_type})}),this.relMain[0].spec_items=e,this.form.main_items=e)},relMainClick(){this.mainVisible=!0,this.setMainStatus=!0},handleCancel(){this.$router.back(-1)}}},h=(0,r.A)(d,function(){var e=this,t=e._self._c;return t("el-form",{ref:"form",staticClass:"box-set page-package",attrs:{model:e.form,"label-width":"120px"}},[t("el-card",{attrs:{header:$t("jky3co6","设置规则名称","lang"),shadow:"naver"}},[t("el-form-item",{attrs:{label:$t("eyrn2","名称","lang"),prop:"package_name",rules:{required:!0,message:$t("6z8ljk8","促销名称不能为空","lang"),trigger:"blur"}}},[t("el-col",{attrs:{span:20}},[t("el-input",{attrs:{maxlength:30,placeholder:$t("nm4xng6","最多30个字","lang")},model:{value:e.form.package_name,callback:function(t){e.$set(e.form,"package_name",t)},expression:"form.package_name"}})],1)],1),t("el-form-item",{attrs:{label:$t("7qcvcm5","选择主商品","lang")}},[t("el-col",{attrs:{span:20}},[t("el-button",{staticClass:"el-icon-plus",attrs:{type:"primary",size:"mini",round:""},on:{click:e.relMainClick}},[e._v($t("2tupti7"," 主商品选择 ","lang"))]),t("GoodsSelect",{attrs:{"items-visible":e.mainVisible,"get-status":e.setMainStatus,single:e.singleData,"rel-items-ids":e.relMain,"item-type":e.form.item_type},on:{chooseStore:e.chooseMainAction,closeStoreDialog:e.closeMainDialogAction}})],1),t("el-table",{staticStyle:{"line-height":"normal"},attrs:{data:e.relMain}},[t("el-table-column",{attrs:{label:"ID",prop:"item_id",width:"60"}}),t("el-table-column",{attrs:{label:$t("eyrn2","名称","lang"),prop:"item_name","min-width":"200"}}),t("el-table-column",{attrs:{label:$t("o06w2","规格","lang"),width:"200"},scopedSlots:e._u([{key:"default",fn:function(i){return[i.row.nospec||i.row.spec_items?!i.row.nospec&&i.row.spec_items?t("div",{staticClass:"goods-sku-check",on:{click:function(t){return e.handleSkuDialogShow(i.row.spec_items.length)}}},[e._v($t("n4lgqw6"," 选择规格 ","lang"))]):t("div",[e._v($t("cvevh3","单规格","lang"))]):t("div",[e._v($t("dpu363","多规格","lang"))])]}}])})],1)],1)],1),t("el-card",{attrs:{header:$t("5gf5iy5","设置主商品","lang"),shadow:"naver"}},[e.form.main_items.length>0?t("el-table",{staticStyle:{"line-height":"normal"},attrs:{data:e.form.main_items}},[t("el-table-column",{attrs:{label:"ID",prop:"item_id",width:"60"}}),t("el-table-column",{attrs:{label:$t("eyrn2","名称","lang"),prop:"item_title"}}),t("el-table-column",{attrs:{label:$t("o06w2","规格","lang"),prop:"item_spec_desc"}}),t("el-table-column",{attrs:{label:$t("gegne3","活动价","lang"),width:"100"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-input",{attrs:{min:"0.01",size:"mini",onkeyup:"value=value.replace(/[^\\d{1,}\\.\\d{1,}|\\d{1,}]/g,'')"},model:{value:i.row.item_price,callback:function(t){e.$set(i.row,"item_price",t)},expression:"scope.row.item_price"}},[t("i",{staticClass:"el-input__icon",attrs:{slot:"prefix"},slot:"prefix"},[e._v(e._s(e.cursymbol))])])]}}],null,!1,2938864660)}),t("el-table-column",{attrs:{label:$t("hkxb2","操作","lang"),width:"50"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("i",{staticClass:"iconfont icon-trash-alt",on:{click:function(t){return e.deleteMainItemRow(i.$index,e.form.main_items)}}})]}}],null,!1,503084458)})],1):e._e()],1),t("el-card",{attrs:{header:$t("12jxyli","选择适用商品 (最大选择10个商品)","lang"),shadow:"naver"}},[t("SkuSelector",{attrs:{data:e.relItems,"is-input-show":!1,"rel-store":e.curStore,"need-store":!0,"lock-store":!0,limit:1,"hidden-data":e.relMain},on:{change:e.getItems}})],1),t("el-card",{attrs:{header:$t("i5lh9n4","设置商品","lang"),shadow:"naver"}},[e.form.items.length>0?t("el-table",{staticStyle:{"line-height":"normal"},attrs:{data:e.form.items}},[t("el-table-column",{attrs:{label:"ID",prop:"item_id",width:"60"}}),t("el-table-column",{attrs:{label:$t("eyrn2","名称","lang"),prop:"item_title"}}),t("el-table-column",{attrs:{label:$t("o06w2","规格","lang"),prop:"item_spec_desc"}}),t("el-table-column",{attrs:{label:$t("gegne3","活动价","lang"),width:"100"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-input",{attrs:{min:"0.01",size:"mini",onkeyup:"value=value.replace(/[^\\d{1,}\\.\\d{1,}|\\d{1,}]/g,'')"},model:{value:i.row.new_price,callback:function(t){e.$set(i.row,"new_price",t)},expression:"scope.row.new_price"}},[t("i",{staticClass:"el-input__icon",attrs:{slot:"prefix"},slot:"prefix"},[e._v(e._s(e.cursymbol))])])]}}],null,!1,114127933)}),t("el-table-column",{attrs:{label:$t("hkxb2","操作","lang"),width:"50"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("i",{staticClass:"iconfont icon-trash-alt",on:{click:function(t){return e.deleteItemRow(i.$index,e.form.items)}}})]}}],null,!1,1914607797)})],1):e._e()],1),t("el-card",{attrs:{header:$t("q6pis16","设置商品组合","lang"),shadow:"naver"}},[t("el-form-item",{attrs:{label:$t("infiw44","适用会员","lang")}},[t("el-checkbox-group",{model:{value:e.validGrade,callback:function(t){e.validGrade=t},expression:"validGrade"}},[e._l(e.memberGrade,function(i){return t("el-checkbox",{key:i.grade_id,attrs:{label:i.grade_id}},[e._v(" "+e._s(i.grade_name)+" ")])}),e._l(e.vipGrade,function(i){return t("el-checkbox",{key:i.lv_type,attrs:{label:i.lv_type}},[e._v($t("euf53"," 付费","lang")+e._s(i.grade_name)+" ")])})],2)],1),e.usePlatformVisiable?t("el-form-item",{attrs:{label:$t("ini4sj4","适用平台","lang")}},[t("el-radio-group",{model:{value:e.form.used_platform,callback:function(t){e.$set(e.form,"used_platform",t)},expression:"form.used_platform"}},[t("el-radio",{attrs:{label:0}},[e._v($t("acj85n6"," 全场可用 ","lang"))])],1)],1):e._e(),t("el-form-item",{attrs:{label:$t("fl3fk3","有效期","lang")}},[t("el-col",{attrs:{span:20}},[t("el-date-picker",{attrs:{type:"datetimerange","range-separator":$t("po31","至","lang"),"start-placeholder":$t("f753lz4","生效时间","lang"),"end-placeholder":$t("ikg3cm4","过期时间","lang"),format:"yyyy/MM/dd HH:mm:ss","value-format":"timestamp","default-time":["00:00:00","23:59:59"]},model:{value:e.activity_date,callback:function(t){e.activity_date=t},expression:"activity_date"}})],1)],1)],1),t("el-dialog",{attrs:{title:$t("l60usga","选择sku选择sku","lang"),visible:e.dialogVisible,width:"50%"},on:{"update:visible":function(t){e.dialogVisible=t}}},[t("el-table",{ref:"skuTable",attrs:{data:e.skus},on:{"selection-change":e.handleSkuChange}},[t("el-table-column",{attrs:{type:"selection",width:"55"}}),t("el-table-column",{attrs:{label:$t("ht82nv4","规格名称","lang")},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(t.row.item_spec_desc)+" ")]}}])}),t("el-table-column",{attrs:{label:$t("e04l2","价格","lang")},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" ¥"+e._s(t.row.price/100)+" ")]}}])})],1),t("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.dialogVisible=!1}}},[e._v($t("caoqm3","取 消","lang"))]),t("el-button",{attrs:{type:"primary"},on:{click:e.handleSkuSubmit}},[e._v($t("hnjoo3","确 定","lang"))])],1)],1),t("div",{staticClass:"content-center"},[e.hasSaveButton?t("el-button",{attrs:{type:"primary"},on:{click:function(t){return e.submitActivityAction()}}},[e._v($t("cp35x4"," 保存 ","lang"))]):e._e(),t("el-button",{nativeOn:{click:function(t){return e.handleCancel.apply(null,arguments)}}},[e._v($t("m1m0m4"," 返回 ","lang"))])],1)],1)},[],!1,null,"6e3f14b6",null),u=h.exports}}]);