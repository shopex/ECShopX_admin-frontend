"use strict";(self.webpackChunkecshopx_admin=self.webpackChunkecshopx_admin||[]).push([[6991],{26991:function(t,e,a){a.r(e),a.d(e,{default:function(){return u}});a(44114),a(18111),a(7588),a(61701);var i=a(18979),s=a.n(i),r=a(21837),n=a(65124),d=a(98818),l=a(5134),o=a(5748),h=a(59025),m=a(26456),g={components:{SkuSelector:r.A,Treeselect:s()},inject:["refresh"],data(){return{relItems:[],activity_date:"",validGrade:[],vipGrade:[],memberGrade:[],rule:{day:0,limit:1},form:{limit_name:"",items:[],start_time:0,end_time:0,valid_grade:[],use_bound:"goods",item_category:[],tag_ids:[],brand_ids:[]},relMain:[],setMainStatus:!1,mainVisible:!1,hasSaveButton:!0,zdItemHidden:!1,categoryHidden:!0,categoryList:[],tagHidden:!0,tag:{list:[],form:{tag_ids:[]},currentTags:[],tags:[]},brandHidden:!0,brand:{list:[],form:{brand_ids:[]},currentBrands:[],brands:[]},ItemsList:[],invalidItemsList:[],params:{page:1,pageSize:-1,item_type:"normal",templates_id:"",keywords:"",category:0,is_warning:!1,tag_id:"",is_gift:"all",type:0,is_sku:"true",item_id:""}}},mounted(){this.getListVipGrade(),this.getGradeList(),this.$route.query.isshow&&(this.hasSaveButton=!1),this.$route.params.limit_id&&this.getLimitPromotionsInfo(this.$route.params.limit_id),this.fetchMainCate(),this.getAllTagLists(),this.getBrandList("",!0)},methods:{submitActivityAction(){const t=this;this.activity_date.length>0&&(this.form.start_time=this.activity_date[0],this.form.end_time=this.activity_date[1]),this.validGrade.length>0&&(this.form.valid_grade=this.validGrade),this.form.day=this.rule.day,this.form.limit=this.rule.limit;let e=JSON.parse(JSON.stringify(this.form));"goods"!=e.use_bound&&(e.items=[]),this.$route.params.limit_id?(0,l.updateLimitPromotions)(this.$route.params.limit_id,e).then(e=>{this.loading=!1,this.$message({message:$t("ai8d7e4","修改成功","lang"),type:"success",duration:2e3,onClose(){t.refresh(),t.$router.go(-1)}})}).catch():(0,l.createLimitPromotions)(e).then(e=>{this.loading=!1,this.$message({message:$t("e7ygyc4","添加成功","lang"),type:"success",duration:2e3,onClose(){t.refresh(),t.$router.go(-1)}})}).catch()},getItems(t){let e=[];t.forEach(t=>{e.push(t.itemId)}),this.form.items=e},getLimitPromotionsInfo(t){(0,l.getLimitPromotionsInfo)(t).then(t=>{let e=t.data.data,a={limit_name:e.limit_name,item_category:e.item_category,tag_ids:e.tag_ids,tag_list:e.tag_list,brand_ids:e.brand_ids,brand_list:e.brand_list,rel_brand_ids:e.rel_brand_ids,rel_category_ids:e.rel_category_ids,rel_tag_ids:e.rel_tag_ids};Object.assign(this.form,a),this.rule=JSON.parse(t.data.data.rule),this.relItems=t.data.data.itemTreeLists,this.validGrade=t.data.data.valid_grade,this.activity_date=[t.data.data.start_time,t.data.data.end_time],this.zdItemHidden=!0,this.categoryHidden=!0,this.tagHidden=!0,this.brandHidden=!0,1==t.data.data.use_bound&&(this.form.use_bound="goods",this.zdItemHidden=!1),2==t.data.data.use_bound&&(this.form.use_bound="category",this.categoryHidden=!1,this.generateSku()),3==t.data.data.use_bound&&(this.form.use_bound="tag",this.tagHidden=!1,this.tag.currentTags=t.data.data.tag_list||[],this.showTags(),this.generateSku()),4==t.data.data.use_bound&&(this.form.use_bound="brand",this.brandHidden=!1,this.brand.currentBrands=t.data.data.brand_list||[],this.showBrands(),this.generateSku())})},handleCancel(){this.$router.back(-1)},getListVipGrade(){(0,d.listVipGrade)().then(t=>{null!=t&&t.data.data&&t.data.data.length>0&&(this.vipGrade=t.data.data)})},getGradeList(){(0,n.getGradeList)().then(t=>{if(null!=t&&t.data.data&&t.data.data.length>0){var e=t.data.data;e&&(this.memberGrade=e)}})},itemTypeChange:function(t){this.params.main_cat_id="",this.params.tag_id="",this.params.brand_id="",this.zdItemHidden=!0,this.categoryHidden=!0,this.tagHidden=!0,this.brandHidden=!0,this.form.items=[],this.invalidItemsList=[],this.form.rel_item_ids=[],this.form.itemTreeLists=[],this.form.item_category=[],this.form.item_category=[],this.tag.currentTags=[],"goods"===t?this.zdItemHidden=!1:"category"===t?(this.form.rel_item_ids=[],this.form.itemTreeLists=[],this.categoryHidden=!1,this.form.item_category=[]):"tag"===t?(this.tagHidden=!1,this.tag.currentTags=[],this.showTags()):"brand"===t&&(this.brandHidden=!1,this.brand.currentBrands=[],this.showBrands())},fetchMainCate:function(){(0,o.getCategory)({is_main_category:!0,ignore_none:!0}).then(t=>{this.categoryList=(0,m.IO)(t.data.data,{id:"category_id",label:"category_name",children:"children"})})},addItemTag:function(){this.tag.currentTags=[],this.item_id.length?(this.showTags(),this.tag.form.item_ids=this.item_id):this.$message({type:"error",message:$t("eajgmxa","请选择至少一个商品!","lang")})},showTags:function(){this.tag.tags=[...this.tag.list],this.tag.tags.forEach((t,e)=>{-1!=this.tag.currentTags.findIndex(e=>e.tag_id==t.tag_id)&&this.tag.tags.splice(e,1)})},tagRemove:function(t){this.tag.tags.unshift(this.tag.currentTags[t]),this.tag.currentTags.splice(t,1),this.form.tag_ids=[];let e=[],a=[];this.tag.currentTags.forEach(t=>{this.form.tag_ids.push(t.tag_id);let i=[];this.ItemsList.forEach(e=>{-1!=e.tag_ids.indexOf(t.tag_id)&&i.push(e)}),e=i;let s=[];this.invalidItemsList.forEach(e=>{-1!=e.tag_ids.indexOf(t.tag_id)&&s.push(e)}),a=s}),this.ItemsList=e,this.invalidItemsList=a,this.getItems(this.ItemsList)},tagAdd:function(t,e){if(this.activity_date.length<=0)return this.$message({type:"error",message:$t("dvs78h8","请选择活动时间!","lang")}),!1;-1==this.tag.currentTags.findIndex(e=>e.tag_id==t.tag_id)&&(this.tag.currentTags.push(t),this.tag.tags.splice(e,1)),this.form.tag_ids=[],this.tag.currentTags.forEach(t=>{this.form.tag_ids.push(t.tag_id)}),this.params.tag_id=t.tag_id,this.getGoodsList()},getAllTagLists:function(){(0,o.getTagList)({page:1,pageSize:500}).then(t=>{this.tag.list=t.data.data.list})},getBrandList:function(t="",e=!1){const a=[];(0,o.getGoodsAttr)({page:1,pageSize:1e3,attribute_type:"brand",attribute_name:t,attribute_ids:e?this.form.brand_id:""}).then(t=>{for(let e of t.data.data.list)a.push({attribute_name:e.attribute_name,attribute_id:e.attribute_id});this.brand.list=a})},showBrands:function(){this.brand.brands=[...this.brand.list],this.brand.brands.forEach((t,e)=>{-1!=this.brand.currentBrands.findIndex(e=>e.attribute_id==t.attribute_id)&&this.brand.brands.splice(e,1)})},brandAdd:function(t,e){if(this.activity_date.length<=0)return this.$message({type:"error",message:$t("dvs78h8","请选择活动时间!","lang")}),!1;-1==this.brand.currentBrands.findIndex(e=>e.attribute_id==t.attribute_id)&&(this.brand.currentBrands.push(t),this.brand.brands.splice(e,1)),this.form.brand_ids=[],this.brand.currentBrands.forEach(t=>{this.form.brand_ids.push(t.attribute_id)}),this.params.brand_id=t.attribute_id,this.getGoodsList()},brandRemove:function(t){let e=[];this.ItemsList.forEach(a=>{this.brand.currentBrands[t].attribute_id!=a.brand_id&&e.push(a)});let a=[];this.invalidItemsList.forEach(e=>{this.brand.currentBrands[t].attribute_id!=e.brand_id&&a.push(e)}),this.invalidItemsList=a,this.ItemsList=e,this.getItems(this.ItemsList),this.brand.brands.unshift(this.brand.currentBrands[t]),this.brand.currentBrands.splice(t,1),this.form.brand_ids=[],this.brand.currentBrands.forEach(t=>{this.form.brand_ids.push(t.attribute_id)})},getGoodsList:function(){let t=JSON.parse(JSON.stringify(this.params));this.$route.params.limit_id&&(t.activity_id=this.$route.params.limit_id),t.seckill_type=this.form.seckill_type,t.activity_release_time=t.activity_start_time=this.activity_date[0],t.activity_end_time=this.activity_date[1],"all"==t.is_gift&&this.$delete(t,"is_gift"),(0,l.seckillActivityGetItemsList)(t).then(t=>{let e=t.data.data.list.validItems.concat(this.ItemsList),a=t.data.data.list.invalidItems.concat(this.invalidItemsList),i=[],s=[],r={},n={};e.forEach(t=>{let e=[];t.tagList.forEach(t=>{e.push(t.tag_id)}),t.tag_ids=e,r[t.item_id]||(i.push(t),r[t.item_id]=!0)}),a.forEach(t=>{let e=[];t.tagList.forEach(t=>{e.push(t.tag_id)}),t.tag_ids=e,n[t.item_id]||(s.push(t),n[t.item_id]=!0)}),this.ItemsList=i,this.invalidItemsList=s,this.getItems(this.ItemsList)})},categorySelect:function(t,e){this.params.main_cat_id=t.category_id,this.getGoodsList()},categoryDeselect:function(t,e){let a;a=[],this.ItemsList.forEach((e,i)=>{t.category_id!=e.item_main_cat_id&&a.push(e)});let i=[];this.invalidItemsList.forEach(e=>{t.category_id!=e.item_main_cat_id&&i.push(e)}),this.invalidItemsList=i,this.ItemsList=a,this.getItems(this.ItemsList)},generateSku(){let t;t=[];let e=[],a=JSON.parse(JSON.stringify(this.relItems));if(a.forEach(e=>{e.nospec||0!==e.spec_items.length||t.push(e.default_item_id)}),t.length>0){this.params.item_id=t,(0,o.getItemsList)(this.params).then(t=>{a.forEach(e=>{e.nospec||t.data.data.list.forEach(t=>{e.item_id===t.default_item_id&&e.spec_items.push(t)})}),a.forEach(t=>{e=t.nospec?[...e,t]:[...e,...t.spec_items]}),this.ItemsList=e,this.getItems(e)})}else a.forEach(t=>{e=t.nospec?[...e,t]:[...e,...t.spec_items]}),this.ItemsList=e,this.getItems(e)},uploadHandleTemplate(){let t={file_type:"marketing_goods",file_name:$t("b44ik94","商品模板","lang")};(0,h.exportUploadTemplate)(t).then(t=>{let{data:e}=t.data;if(e.file){var a=document.createElement("a");a.href=e.file,a.download=e.name,document.body.appendChild(a),a.click(),a.remove()}else this.$message({type:"error",message:$t("yndnt89","没有相关数据可导出","lang")})})},uploadHandleChange(t,e){let a={isUploadFile:!0,file_type:"marketing_goods",file:t.raw};(0,h.handleUploadFile)(a).then(t=>{this.$message({type:"success",message:$t("a6esth4","上传成功","lang")});let{data:e}=t.data;if(e.fail.length>0){let t=e.fail.map(t=>t.item_bn);setTimeout(()=>{this.$message({showClose:!0,message:`${$t("ojz3zza","以下商品编号不存在：","lang")}${t}`,type:"error",duration:5e3})},1500)}if(e.succ.length<=0)return;this.relItems=e.succ;let a=[];e.succ.forEach(t=>{t.nospec?a.push(t):a.push(Object.assign(t,{spec_items:[]}))})})}}},c=(0,a(81656).A)(g,function(){var t=this,e=t._self._c;return e("SpPage",{attrs:{title:$t("jky3co6","设置规则名称","lang")}},[e("el-form",{ref:"form",staticClass:"box-set",attrs:{model:t.form,"label-width":"120px"}},[e("el-card",{attrs:{shadow:"naver"}},[e("el-form-item",{attrs:{label:$t("eyrn2","名称","lang"),prop:"limit_name",rules:{required:!0,message:$t("nk4r6r7","请填写规则名称","lang"),trigger:"blur"}}},[e("el-col",{attrs:{span:20}},[e("el-input",{attrs:{maxlength:30,placeholder:$t("nm4xng6","最多30个字","lang")},model:{value:t.form.limit_name,callback:function(e){t.$set(t.form,"limit_name",e)},expression:"form.limit_name"}})],1)],1),e("el-form-item",{attrs:{label:$t("i56ebc4","购买规则","lang")}},[e("el-input",{staticClass:"inline-input",staticStyle:{width:"100px"},attrs:{maxlength:30},model:{value:t.rule.day,callback:function(e){t.$set(t.rule,"day",e)},expression:"rule.day"}}),t._v($t("to04ti6"," 天，购买 ","lang")),e("el-input",{staticClass:"inline-input",staticStyle:{width:"100px"},attrs:{maxlength:30},model:{value:t.rule.limit,callback:function(e){t.$set(t.rule,"limit",e)},expression:"rule.limit"}}),t._v($t("e39m3"," 件 ","lang")),e("p",{staticClass:"frm-tips"},[t._v($t("n6mjxj18"," 天数设置0视为此次活动有效期内，例如：0天，购买1件是指活动有效期内只能购买一件商品 ","lang"))])],1),e("el-form-item",{attrs:{label:$t("infiw44","适用会员","lang")}},[e("el-checkbox-group",{model:{value:t.validGrade,callback:function(e){t.validGrade=e},expression:"validGrade"}},[t._l(t.memberGrade,function(a){return e("el-checkbox",{key:a.grade_id,attrs:{label:a.grade_id}},[t._v(" "+t._s(a.grade_name)+" ")])}),t._l(t.vipGrade,function(a){return e("el-checkbox",{key:a.lv_type,attrs:{label:a.lv_type}},[t._v($t("euf53"," 付费","lang")+t._s(a.grade_name)+" ")])})],2)],1),e("el-form-item",{attrs:{label:$t("fl3fk3","有效期","lang")}},[e("el-col",{attrs:{span:20}},[e("el-date-picker",{attrs:{type:"datetimerange","range-separator":$t("po31","至","lang"),"start-placeholder":$t("f753lz4","生效时间","lang"),"end-placeholder":$t("ikg3cm4","过期时间","lang"),"value-format":"yyyy-MM-dd HH:mm:ss","default-time":["00:00:00","23:59:59"]},model:{value:t.activity_date,callback:function(e){t.activity_date=e},expression:"activity_date"}})],1)],1)],1),e("el-card",{attrs:{header:$t("z3v7e06","选择限购商品","lang"),shadow:"naver"}},[e("el-form-item",{attrs:{label:$t("ingkrl4","适用商品","lang")}},[e("el-radio-group",{on:{change:t.itemTypeChange},model:{value:t.form.use_bound,callback:function(e){t.$set(t.form,"use_bound",e)},expression:"form.use_bound"}},[e("el-radio",{attrs:{label:"goods"}},[t._v($t("q7xfmc8"," 指定商品适用 ","lang"))]),e("el-radio",{attrs:{label:"category"}},[t._v($t("xx0gpa8"," 指定分类适用 ","lang"))]),e("el-radio",{attrs:{label:"tag"}},[t._v($t("5ghnxxa"," 指定商品标签适用 ","lang"))]),e("el-radio",{attrs:{label:"brand"}},[t._v($t("oiwwqs8"," 指定品牌适用 ","lang"))])],1)],1),t.zdItemHidden?t._e():e("div",{staticStyle:{position:"relative"}},[e("SkuSelector",{attrs:{data:t.relItems},on:{change:t.getItems}}),e("div",{staticStyle:{position:"absolute",bottom:"0px",left:"112px"}},[e("el-upload",{staticStyle:{display:"inline-block",height:"0"},attrs:{action:"","on-change":t.uploadHandleChange,"auto-upload":!1,"show-file-list":!1}},[e("el-button",{attrs:{type:"primary"}},[t._v($t("7afr9o6"," 批量上传 ","lang"))])],1),e("el-button",{staticStyle:{"margin-left":"10px"},attrs:{type:"primary"},on:{click:function(e){return t.uploadHandleTemplate()}}},[t._v($t("gbapcg6"," 下载模板 ","lang"))])],1)],1),e("el-col",{attrs:{xs:12,sm:12,md:12}},[t.categoryHidden?t._e():e("div",{staticStyle:{height:"350px"}},[e("treeselect",{attrs:{"no-results-text":$t("dczhhj4","暂无结果","lang"),options:t.categoryList,"show-count":!0,multiple:!0,"disable-branch-nodes":!0,clearable:!1},on:{select:t.categorySelect,deselect:t.categoryDeselect},model:{value:t.form.item_category,callback:function(e){t.$set(t.form,"item_category",e)},expression:"form.item_category"}})],1)]),t.tagHidden?t._e():[e("div",{staticClass:"selected-tags view-flex"},[e("div",{staticClass:"label"},[t._v($t("rbsw8d6","已选中标签：","lang"))]),e("div",{staticClass:"view-flex-item"},t._l(t.tag.currentTags,function(a,i){return e("el-tag",{key:i,attrs:{closable:"",size:"small","disable-transitions":!1},on:{close:function(e){return t.tagRemove(i)}}},[t._v(" "+t._s(a.tag_name)+" ")])}),1)]),e("div",t._l(t.tag.tags,function(a,i){return e("el-tag",{key:i,staticClass:"tag-item",attrs:{size:"medium",color:"#ffffff","disable-transitions":!1},nativeOn:{click:function(e){return t.tagAdd(a,i)}}},[t._v(" "+t._s(a.tag_name)+" ")])}),1)],t.brandHidden?t._e():[e("div",{staticClass:"selected-tags view-flex"},[e("div",{staticClass:"label"},[t._v($t("r8xpax6","已选中品牌：","lang"))]),e("div",{staticClass:"view-flex-item"},t._l(t.brand.currentBrands,function(a,i){return e("el-tag",{key:i,attrs:{closable:"",size:"small","disable-transitions":!1},on:{close:function(e){return t.brandRemove(i)}}},[t._v(" "+t._s(a.attribute_name)+" ")])}),1)]),e("div",t._l(t.brand.brands,function(a,i){return e("el-tag",{key:i,staticClass:"tag-item",attrs:{size:"medium",color:"#ffffff","disable-transitions":!1},nativeOn:{click:function(e){return t.brandAdd(a,i)}}},[t._v(" "+t._s(a.attribute_name)+" ")])}),1)]],2)],1),e("div",{staticClass:"text-center",attrs:{slot:"page-footer"},slot:"page-footer"},[t.hasSaveButton?e("el-button",{attrs:{type:"primary"},on:{click:function(e){return t.submitActivityAction()}}},[t._v($t("cp35x4"," 保存 ","lang"))]):t._e(),e("el-button",{nativeOn:{click:function(e){return t.handleCancel.apply(null,arguments)}}},[t._v($t("m1m0m4"," 返回 ","lang"))])],1)],1)},[],!1,null,null,null),u=c.exports}}]);