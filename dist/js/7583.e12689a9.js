"use strict";(self.webpackChunkecshopx_admin=self.webpackChunkecshopx_admin||[]).push([[7583],{57583:function(t,e,a){a.r(e),a.d(e,{default:function(){return i}});a(18111),a(20116),a(7588),a(61701);var r={data(){const t=this.$createElement;return{loading:!1,categoryList:[],appID:"",appCodeUrl:"",curPageUrl:"",mapData:null,cacheRowData:null,categoryDialog:!1,categoryForm:{category_id:"",category_name:"",sort:0,parent_id:0,parent_name:"",image_url:"",customize_page_id:""},categoryFormList:[{label:$t("av333s4","分类名称","lang"),key:"category_name",type:"input",placeholder:$t("mnzxr37","请输入分类名称","lang"),required:!0,message:$t("adohlc4","不能为空","lang")},{label:$t("av5kqa4","分类排序","lang"),key:"sort",type:"number"},{label:$t("exjndy4","父级分类","lang"),key:"parent_name",type:"text",isShow:({key:t},e)=>this.categoryForm.parent_id>0&&!this.categoryForm.category_id},{label:$t("av3jlq4","分类图片","lang"),key:"image_url",component:({key:e},a)=>t("SpImagePicker",{model:{value:a[e],callback:t=>{this.$set(a,e,t)}}})}]}},created(){this.mapData=new Map},mounted(){this.init(),this.fetchWechatList(),this.classification()},methods:{async classification(){let{list:t}=await this.$api.wxa.getCustomPageList({page:1,pageSize:10,page_type:"category",template_name:"yykweishop"});t.forEach(t=>{t.title=t.page_name,t.value=t.id})},async init(){const t=await this.getCategory();this.categoryList=t},async fetchWechatList(){const{list:t}=await this.$api.minimanage.gettemplateweapplist(),{authorizer:e={}}=t.find(t=>"yykweishop"==t.key_name)||{},{authorizer_appid:a}=e;this.appID=a},addCategory(){this.categoryForm={category_id:"",category_name:"",sort:0,parent_id:0,parent_name:"",image_url:"",customize_page_id:""},this.categoryDialog=!0},editCategory({parent_id:t,category_id:e,category_name:a,sort:r,image_url:i,customize_page_id:o}){this.categoryForm={category_id:e,category_name:a,sort:r,parent_id:t,image_url:i,customize_page_id:0==o?"":o},this.categoryDialog=!0},appendChildren(t){const{category_id:e,category_name:a}=t;this.cacheRowData=t,this.categoryForm={category_id:"",category_name:"",sort:0,parent_id:e,parent_name:a,image_url:"",customize_page_id:""},this.categoryDialog=!0},async handleClick(t){const e="pages/item/list";this.curPageUrl=`${e}?cat_id=${t}`;let a={wxaAppId:this.appID,page:e,cat_id:t};const{base64Image:r}=await this.$api.marketing.getPageCode(a);this.appCodeUrl=r},handleDownload(t){var e=document.createElement("a"),a=t;this.appCodeUrl&&(e.href=this.appCodeUrl,e.download=a+".png",e.click())},async getCategory(t=0){return(await this.$api.goods.getCategory({parent_id:t})).map(t=>({...t,hasChildren:"1"==t.has_children}))},async load(t,e,a){const{category_id:r}=t;this.mapData.set(r,{tree:t,treeNode:e,resolve:a});a(await this.getCategory(r,e))},async onCategoryFormSubmit(){const{category_name:t,sort:e,image_url:a,customize_page_id:r,parent_id:i,category_id:o}=this.categoryForm;o?(await this.$api.goods.editCategory({category_name:t,sort:e,image_url:a,category_id:o,customize_page_id:r}),this.$message.success($t("gmjwui4","编辑成功","lang"))):(await this.$api.goods.addCategory({category_name:t,sort:e,image_url:a,customize_page_id:r,parent_id:"0"!=i?i:void 0}),this.$message.success($t("e7ygyc4","添加成功","lang"))),this.refreshNode(i),this.categoryDialog=!1},async deleteCategory(t){await this.$confirm($t("59pcidg","此操作将删除该分类, 是否继续?","lang"),$t("hn562","提示","lang"),{confirmButtonText:$t("kzjg2","确定","lang"),cancelButtonText:$t("ev022","取消","lang")});const{parent_id:e,category_id:a}=t;this.cacheRowData=t,await this.$api.goods.deleteCategory(a),this.$message.success($t("uehn3s6","删除分类成功","lang")),this.refreshNode(e)},async refreshNode(t){if("0"==t)return void this.init();const e=await this.getCategory(t),{resolve:a}=this.mapData.get(t)||{};if(a)if(e.length>0)a(e);else{const{lazyTreeNodeMap:e}=this.$refs.tableTree.store.states;this.$set(e,t,[])}else{const t=this.$refs.tableTree.store;this.cacheRowData.hasChildren=!0,this.$nextTick(()=>{t.loadOrToggle(this.cacheRowData)})}}}},i=(0,a(81656).A)(r,function(){var t=this,e=t._self._c;return e("SpPage",[e("div",{staticClass:"page-goods-salecategory"},[e("div",{staticClass:"action-container"},[e("el-button",{attrs:{type:"primary"},on:{click:t.addCategory}},[t._v($t("gf7rtk8"," 添加销售分类 ","lang"))])],1),e("el-table",{ref:"tableTree",attrs:{data:t.categoryList,"row-key":"category_id",border:"",lazy:"","tree-props":{children:"children",hasChildren:"hasChildren"},load:t.load,width:"100%"}},[e("el-table-column",{attrs:{label:"",width:"60"}}),e("el-table-column",{attrs:{label:$t("av333s4","分类名称","lang"),prop:"category_name"},scopedSlots:t._u([{key:"default",fn:function(a){return[e("div",{staticClass:"whitespace-nowrap"},[t._v(" "+t._s(a.row.category_name)+" ")])]}}])}),e("el-table-column",{attrs:{prop:"sort",label:$t("av5kqa4","分类排序","lang"),width:"80"},scopedSlots:t._u([{key:"default",fn:function(a){return[e("div",[t._v(t._s(a.row.sort))])]}}])}),e("el-table-column",{attrs:{label:$t("av3jlq4","分类图片","lang"),width:"200"},scopedSlots:t._u([{key:"default",fn:function(a){return[e("div",{staticClass:"img-container"},[a.row.image_url?e("SpImage",{attrs:{src:a.row.image_url,width:48,height:48}}):t._e()],1)]}}])}),e("el-table-column",{attrs:{label:$t("hkxb2","操作","lang"),width:"320"},scopedSlots:t._u([{key:"default",fn:function(a){return[e("el-button",{attrs:{type:"text"}},[e("router-link",{attrs:{to:{path:t.IS_DISTRIBUTOR()?"/shopadmin/entity/goodsphysical":"/products/product-manage/self-products",query:{category:a.row.path}}}},[t._v($t("akaly76"," 查看商品 ","lang"))])],1),a.row.category_level<3?e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.appendChildren(a.row)}}},[t._v($t("1vg0hl6"," 新增子类 ","lang"))]):t._e(),e("el-button",{attrs:{type:"text"},on:{click:function(e){return t.editCategory(a.row)}}},[t._v($t("juz394"," 编辑 ","lang"))]),t.appID?e("el-popover",{attrs:{placement:"top",width:"200",trigger:"click"}},[e("div",[e("img",{staticClass:"page-code",attrs:{src:t.appCodeUrl}}),e("div",{staticClass:"page-btns"},[e("el-button",{attrs:{type:"primary",plain:"",size:"mini"},on:{click:function(e){return t.handleDownload(a.row.category_name)}}},[t._v($t("axjir55"," 下载码 ","lang"))]),e("el-button",{directives:[{name:"clipboard",rawName:"v-clipboard:copy",value:t.curPageUrl,expression:"curPageUrl",arg:"copy"}],attrs:{type:"primary",plain:"",size:"mini"}},[t._v($t("j66ck06"," 复制链接 ","lang"))])],1)]),e("el-button",{staticStyle:{width:"45px"},attrs:{slot:"reference",type:"text"},on:{click:function(e){return t.handleClick(a.row.category_id)}},slot:"reference"},[t._v($t("fhh3r4"," 投放 ","lang"))])],1):t._e(),e("el-button",{attrs:{type:"text"},nativeOn:{click:function(e){return e.preventDefault(),t.deleteCategory(a.row)}}},[t._v($t("db22k4"," 删除 ","lang"))])]}}])})],1),e("SpDialog",{ref:"categoryDialogRef",attrs:{title:t.categoryForm.category_id>0?$t("gmhewg4","编辑分类","lang"):$t("e7vz0a4","添加分类","lang"),modal:!1,form:t.categoryForm,"form-list":t.categoryFormList},on:{onSubmit:t.onCategoryFormSubmit},model:{value:t.categoryDialog,callback:function(e){t.categoryDialog=e},expression:"categoryDialog"}})],1)])},[],!1,null,null,null).exports}}]);