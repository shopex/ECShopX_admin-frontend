"use strict";(self.webpackChunkecshopx_admin=self.webpackChunkecshopx_admin||[]).push([[8415],{58415:function(e,a,t){t.r(a),t.d(a,{default:function(){return r}});t(18111),t(20116),t(7588);var o=t(22541),i=t(26456),n=t(81046),l={name:"",data(){const e=this.$createElement,a=()=>"email"==this.companyForm.auth_type,t=(e,a,t)=>{const{auth_type:o}=this.companyForm;"email"!=o||"email"==o&&a?t():t($t("adohlc4","不能为空","lang"))};return{qrcodeUrl:"",qrcodeName:"",qrCodeBgImage:"",queryForm:{name:"",enterprise_sn:"",auth_type:"",distributor_id:""},sendEmailDialog:!1,sendEmaiLoading:!1,sendEmailForm:{email:"",enterprise_id:""},sendEmailFormList:[{component:()=>e("el-alert",{attrs:{title:$t("prqyfq16","请确保填写的邮箱可以正常接受邮件，若五分钟内未收到测试邮件，请检查邮箱配置后再尝试。","lang"),type:"warning",closable:!1}})},{label:$t("d3ju6o4","收件地址","lang"),key:"email",type:"input",placeholder:$t("3valulc","用于接受验证码的邮箱地址","lang"),required:!0,message:$t("wq2f1c8","收件地址不能为空","lang")}],setting:(0,o.createSetting)({actions:[{name:$t("mekb2","编辑","lang"),key:"modify",type:"button",buttonType:"text",visible:e=>!(this.IS_ADMIN()&&"0"!=e.distributor_id),action:{handler:async([e])=>{Object.keys(this.companyForm).forEach(a=>this.companyForm[a]=e[a]),this.companyForm.is_employee_check_enabled="true"==this.companyForm.is_employee_check_enabled,this.isShowFooter=!0,this.addDialog=!0}}},{name:$t("ibpi2","查看","lang"),key:"modify",type:"button",buttonType:"text",visible:e=>this.IS_ADMIN()&&"0"!=e.distributor_id,action:{handler:async([e])=>{Object.keys(this.companyForm).forEach(a=>this.companyForm[a]=e[a]),this.companyForm.is_employee_check_enabled="true"==this.companyForm.is_employee_check_enabled,this.isShowFooter=!1,this.addDialog=!0}}},{name:$t("awojcf4","发件测试","lang"),key:"modify",type:"button",buttonType:"text",visible:e=>"email"==e.auth_type&&!(this.IS_ADMIN()&&"0"!=e.distributor_id),action:{handler:async([e])=>{this.sendEmailForm={email:"",enterprise_id:e.id},this.sendEmailDialog=!0}}},{name:$t("c4ffd3","二维码","lang"),key:"modify",type:"button",buttonType:"text",action:{handler:async([e])=>{const{base64Image:a}=await this.$api.member.getEnterpriseQrcode({enterprise_id:e.id});this.qrcodeUrl=a,this.qrcodeName=e.name,e.qr_code_bg_image&&(this.qrCodeBgImage=e.qr_code_bg_image),this.qrDialog=!0}}},{name:$t("7t5mk6","查看员工列表","lang"),key:"modify",type:"button",buttonType:"text",action:{handler:async([e])=>{window.open(`${(0,i.fe)(`/applications/enterprise-purchase/staff-management?company_id=${e.id}`)}`,"_blank")}}}],columns:[{name:$t("aa61as4","企业ID","lang"),key:"id"},{name:$t("84jxj86","企业Logo","lang"),key:"logo",render:(e,{row:a})=>a.logo?e("el-image",{props:{src:a.logo},class:{"company-logo":!0},style:{width:"64px",display:"block"}}):""},{name:$t("aaky9o4","企业名称","lang"),key:"name"},{name:$t("aas9es4","企业编码","lang"),key:"enterprise_sn"},{name:$t("hge52","排序","lang"),key:"sort",showType:"pop-editable",componentProps:{icon:"el-icon-edit",popperClass:"sp-finder__popover-edit",change:async(e,a)=>{await this.$api.member.updateCompanySort({enterprise_id:a.id,sort:e}),this.$refs.finder.refresh()}}},{name:$t("fcjfai4","登录类型","lang"),key:"auth_type",formatter:(e,{auth_type:a},t)=>{const o=n.h.find(e=>e.value==a)?.name;return o}},{name:$t("k1e32","状态","lang"),key:"disabled",render:(e,{row:a})=>e("el-switch",{props:{value:a.disabled+"","active-value":"0","inactive-value":"1"},on:{change:async e=>{await this.$api.member.updateCompanyStatus({enterprise_id:a.id,disabled:e}),a.disabled=e}}})},{name:$t("di507i4","来源店铺","lang"),key:"distributor_name"}]}),validateTypeList:n.h,addDialog:!1,qrDialog:!1,addDialogLoading:!1,isShowFooter:!0,companyForm:{id:"",logo:"",name:"",enterprise_sn:"",sort:"1",auth_type:"mobile",relay_host:"",smtp_port:"",email_user:"",email_password:"",email_suffix:"",is_employee_check_enabled:!1,qr_code_bg_image:""},companyFormList:[{label:$t("aaky9o4","企业名称","lang"),key:"name",type:"input",placeholder:$t("n8i2l77","请输入企业名称","lang"),required:!0,message:$t("adohlc4","不能为空","lang")},{label:$t("aas9es4","企业编码","lang"),key:"enterprise_sn",type:"input",placeholder:$t("n8arg37","请输入企业编码","lang"),required:!0,message:$t("adohlc4","不能为空","lang")},{label:$t("hge52","排序","lang"),key:"sort",component:()=>e("SpInput",{class:"sort-input",attrs:{width:"100px",suffix:$t("9r23dbj","选择器中的企业展示顺序，数字越小越靠前","lang")},model:{value:this.companyForm.sort,callback:e=>{this.$set(this.companyForm,"sort",e)}}})},{label:$t("fcjfai4","登录类型","lang"),key:"auth_type",type:"radio",options:[{label:"mobile",name:$t("ewbd43","手机号","lang")},{label:"account",name:$t("ogwh2","账号","lang")},{label:"email",name:$t("padf2","邮箱","lang")},{label:"qr_code",name:$t("c4ffd3","二维码","lang")}],validator:(e,a,t)=>{a?t():t($t("adohlc4","不能为空","lang"))}},{label:$t("awugug4","发件邮箱","lang"),key:"email_user",type:"input",placeholder:$t("mm8k0f7","请输入发件邮箱","lang"),isShow:a,validator:t},{label:$t("m3it0i7","SMTP服务器","lang"),key:"relay_host",type:"input",placeholder:$t("9ztkoba","请输入SMTP服务器","lang"),isShow:a,validator:t},{label:$t("ldck2","端口","lang"),key:"smtp_port",type:"input",placeholder:$t("erfrcw7","请输入邮箱端口","lang"),isShow:a,validator:t},{label:$t("g9ob2","密码","lang"),key:"email_password",type:"input",placeholder:$t("erkv157","请输入邮箱密码","lang"),isShow:a,validator:t},{label:$t("908o3i8","员工收件邮箱后缀","lang"),key:"email_suffix",type:"input",placeholder:$t("b0x8izb","请输入员工收件邮箱后缀","lang"),isShow:a,validator:t},{label:$t("e5vwo77","是否验证白名单","lang"),key:"is_employee_check_enabled",type:"switch",isShow:()=>"qr_code"==this.companyForm.auth_type},{label:$t("84jxj86","企业Logo","lang"),key:"logo",component:()=>e("SpImagePicker",{model:{value:this.companyForm.logo,callback:e=>{this.$set(this.companyForm,"logo",e)}}}),validator:(e,a,t)=>{a?t():t($t("2eokls5","请选择企业","lang"))},tip:$t("jbbh8wv","建议尺寸100*100，支持 png、jpg 格式，不超过2M","lang")},{label:$t("636yxa7","企业二维码海报","lang"),key:"qr_code_bg_image",component:()=>e("SpImagePicker",{model:{value:this.companyForm.qr_code_bg_image,callback:e=>{this.$set(this.companyForm,"qr_code_bg_image",e)}}}),isShow:()=>"qr_code"==this.companyForm.auth_type,tip:$t("wplrp318","员工邀请亲友海报：建议上传尺寸540*960且格式为png、jpg图片，文件大小为2M内","lang")}]}},created(){},methods:{handleDownload(){if(!this.qrCodeBgImage){var e=document.createElement("a"),a=this.qrcodeName;return void(this.qrcodeUrl&&(e.href=this.qrcodeUrl,e.download=a+".png",e.click(),setTimeout(()=>{this.qrDialog=!1},1e3)))}const t=document.getElementById("qurcodeCanvas"),o=t.getContext("2d"),i=this.qrCodeBgImage,n=this.qrcodeUrl,l=new Image,r=new Image;Promise.all([new Promise((e,a)=>{l.src=i,l.setAttribute("crossOrigin","anonymous"),l.onload=()=>{e()},l.onerror=a}),new Promise((e,a)=>{r.src=n,r.setAttribute("crossOrigin","anonymous"),r.onload=()=>{e()},r.onerror=a})]).then(()=>{t.width=l.width,t.height=l.height,o.drawImage(l,0,0);const e=t.width-350,a=t.height-430;o.font="22px sans-serif",o.fillStyle="#F3B289",o.textAlign="center",o.textBaseline="alphabetic";const i=e+150,n=a+300+35;i>=0&&i<=t.width&&n>=0&&n<=t.height&&o.fillText($t("6l9lub7","扫码进入小程序","lang"),i,n);o.save(),o.beginPath(),o.arc(e+150,a+150,150,0,2*Math.PI,!0),o.closePath(),o.clip(),o.drawImage(r,e,a,300,300),o.restore();const s=document.createElement("a");s.href=t.toDataURL("image/jpeg"),s.download=this.qrcodeName+".png",s.click()}).catch(e=>{})},beforeSearch(e){return{...e,...this.queryForm}},onSearch(){this.$refs.finder.refresh()},addCompany(){this.companyForm=this.$options.data().companyForm,this.addDialog=!0},async onSendEmailSubmit(){const{email:e,enterprise_id:a}=this.sendEmailForm;this.sendEmaiLoading=!0;try{await this.$api.member.sendEmployeeEmail({enterprise_id:a,email:e}),this.sendEmaiLoading=!1,this.$message.success($t("7ssx4q5","邮件已发送","lang"))}catch(e){this.sendEmaiLoading=!1}},async onCompanyFormSubmit(){const{id:e,logo:a,name:t,enterprise_sn:o,auth_type:i,email_user:n,relay_host:l,smtp_port:r,email_password:s,email_suffix:m,is_employee_check_enabled:c,qr_code_bg_image:d,sort:p}=this.companyForm,g={logo:a,name:t,enterprise_sn:o,auth_type:i,relay_host:l,smtp_port:r,email_user:n,email_password:s,email_suffix:m,is_employee_check_enabled:c,qr_code_bg_image:d,sort:p};this.addDialogLoading=!0;try{e?await this.$api.member.updatePurchaseCompany(e,g):await this.$api.member.postPurchaseCompany(g),this.addDialog=!1,this.addDialogLoading=!1,this.onSearch()}catch(e){this.addDialogLoading=!1}}}},r=(0,t(81656).A)(l,function(){var e=this,a=e._self._c;return a("SpPage",[a("SpFilterForm",{attrs:{model:e.queryForm},on:{onSearch:e.onSearch,onReset:e.onSearch}},[a("SpFilterFormItem",{attrs:{prop:"name",label:$t("yzlagu5","企业名称:","lang")}},[a("el-input",{attrs:{placeholder:$t("n8i2l77","请输入企业名称","lang")},model:{value:e.queryForm.name,callback:function(a){e.$set(e.queryForm,"name",a)},expression:"queryForm.name"}})],1),a("SpFilterFormItem",{attrs:{prop:"enterprise_sn",label:$t("z5vvva5","企业编码:","lang")}},[a("el-input",{attrs:{placeholder:$t("n8arg37","请输入企业编码","lang")},model:{value:e.queryForm.enterprise_sn,callback:function(a){e.$set(e.queryForm,"enterprise_sn",a)},expression:"queryForm.enterprise_sn"}})],1),a("SpFilterFormItem",{attrs:{prop:"auth_type",label:$t("gy7ccx5","验证方式:","lang")}},[a("el-select",{attrs:{placeholder:$t("v5sxum7","请选择验证方式","lang")},model:{value:e.queryForm.auth_type,callback:function(a){e.$set(e.queryForm,"auth_type",a)},expression:"queryForm.auth_type"}},e._l(e.validateTypeList,function(e,t){return a("el-option",{key:t,attrs:{label:e.name,value:e.value}})}),1)],1),a("SpFilterFormItem",{attrs:{prop:"distributor_id",label:$t("7kd5ck5","来源店铺:","lang")}},[a("SpSelectShop",{attrs:{clearable:"",placeholder:$t("l72nr3","请选择","lang")},model:{value:e.queryForm.distributor_id,callback:function(a){e.$set(e.queryForm,"distributor_id",a)},expression:"queryForm.distributor_id"}})],1)],1),a("div",{staticClass:"action-container"},[a("el-button",{attrs:{type:"primary",icon:"iconfont icon-xinzengcaozuo-01"},on:{click:e.addCompany}},[e._v($t("tqmwua6"," 添加企业 ","lang"))])],1),a("SpFinder",{ref:"finder",attrs:{"no-selection":"",setting:e.setting,"row-actions-align":"left",hooks:{beforeSearch:e.beforeSearch},url:"/enterprise"}}),a("SpDialog",{ref:"addDialogRef",staticClass:"dg-create-company",attrs:{title:e.companyForm.id?$t("gmgn904","编辑企业","lang"):$t("e7v7cu4","添加企业","lang"),modal:!1,form:e.companyForm,"form-list":e.companyFormList,"confirm-status":e.addDialogLoading,"is-show-footer":e.isShowFooter},on:{onSubmit:e.onCompanyFormSubmit},model:{value:e.addDialog,callback:function(a){e.addDialog=a},expression:"addDialog"}}),a("el-dialog",{attrs:{title:$t("iiybxp6","企业二维码-","lang")+e.qrcodeName,visible:e.qrDialog,width:"30%"},on:{"update:visible":function(a){e.qrDialog=a}}},[a("span",[e._v($t("23ao8c1z","用户扫描该二维码打开小程序时会跳过白名单身份验证步骤，在继续完成授权手机号登录后即可获得相应企业的“员工”身份；已是该企业员工的用户不受影响。","lang"))]),a("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{on:{click:function(a){e.qrDialog=!1}}},[e._v($t("caoqm3","取 消","lang"))]),a("el-button",{attrs:{type:"primary"},on:{click:e.handleDownload}},[e._v($t("vknegp5","下载二维码","lang"))])],1)]),a("SpDialog",{ref:"sendEmailRef",staticClass:"dg-create-company",attrs:{title:$t("awojcf4","发件测试","lang"),"confirm-btn-text":$t("8mg9yc5","发送验证码","lang"),"confirm-status":e.sendEmaiLoading,modal:!1,form:e.sendEmailForm,"form-list":e.sendEmailFormList},on:{onSubmit:e.onSendEmailSubmit},model:{value:e.sendEmailDialog,callback:function(a){e.sendEmailDialog=a},expression:"sendEmailDialog"}}),a("canvas",{staticClass:"qurcode-canvas",attrs:{id:"qurcodeCanvas"}})],1)},[],!1,null,"0bbbcc68",null).exports}}]);